{% extends 'base.html' %}
{% block content %}
<h1>üß† DigitalPsych ‚Äì Dotazn√≠ky</h1>
<p class="muted">V√Ωsledky s√∫ orientaƒçn√© a nenahr√°dzaj√∫ odborn√∫ diagnostiku.</p>

<div class="card">
  <h2>Vyberte dotazn√≠k</h2>
  <div id="grid" class="card-grid"></div>
</div>

<div class="card" id="form"></div>
<div class="card result" id="out" style="display:none"></div>

<script>
async function fetchList(){
  const r = await fetch('/assessments/list');
  return await r.json();
}
async function fetchSchema(id){
  const r = await fetch(`/assessments/${id}/schema`);
  return await r.json();
}
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') n.className=v; else n.setAttribute(k,v); });
  children.forEach(c=> n.appendChild(typeof c==='string'? document.createTextNode(c): c));
  return n;
}
function render(schema){
  const root = document.getElementById('form');
  root.innerHTML='';
  root.appendChild(el('h2', {}, schema.title));
  root.appendChild(el('p', {class:'muted'}, schema.recall));
  schema.items.forEach((it, idx)=>{
    const row = el('div', {class:'row'});
    row.appendChild(el('label', {}, `${idx+1}. ${it.text}`));
    const scale = el('div', {class:'scale'});
    schema.scale.forEach(opt=>{
      const w = el('label');
      const r = el('input', {type:'radio', name: it.id, value: opt});
      w.appendChild(r); w.appendChild(document.createTextNode(' '+opt));
      scale.appendChild(w);
    });
    row.appendChild(scale);
    root.appendChild(row);
  });
  if(schema.impairment_scale && schema.impairment_scale.length){
    const imp = el('div', {class:'row'});
    imp.appendChild(el('strong', {}, 'Ak√Ω vplyv mali tieto probl√©my na pr√°cu/dom√°cnos≈•/vz≈•ahy?'));
    const scale = el('div', {class:'scale'});
    schema.impairment_scale.forEach(opt=>{
      const w = el('label');
      const r = el('input', {type:'radio', name: schema.id+'_imp', value: opt});
      w.appendChild(r); w.appendChild(document.createTextNode(' '+opt));
      scale.appendChild(w);
    });
    imp.appendChild(scale);
    root.appendChild(imp);
  }
  const btn = el('button', {}, 'Vyhodnoti≈•');
  btn.addEventListener('click', ()=> submit(schema.id));
  root.appendChild(btn);
}
function collect(schema){
  const answers=[];
  for(const it of schema.items){
    const sel = document.querySelector(`input[name="${it.id}"]:checked`);
    if(!sel) return null;
    answers.push({ item_id: it.id, label: sel.value });
  }
  const impSel = document.querySelector(`input[name="${schema.id}_imp"]:checked`);
  return { answers, impairment: impSel? impSel.value : null };
}
async function submit(id){
  const schema = window._schema;
  const collected = collect(schema);
  if(!collected){ alert('Pros√≠m, vypl≈àte v≈°etky polo≈æky.'); return; }

  let r, data, text;
  try {
    r = await fetch(`/assessments/${id}/score`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(collected)
    });

    // Ak API vr√°ti chybu, sk√∫sme ju uk√°za≈• pou≈æ√≠vateƒæovi.
    if(!r.ok){
      text = await r.text();
      throw new Error(`Server vr√°til ${r.status} ${r.statusText}\n${text}`);
    }
    data = await r.json();
  } catch (e){
    const out = document.getElementById('out');
    out.style.display='block';
    out.innerHTML = `
      <div class="card">
        <h3>Chyba pri vyhodnocovan√≠</h3>
        <p>Sk√∫s to pros√≠m znova. Ak probl√©m pretrv√°va, pozri server logy.</p>
        <pre style="white-space:pre-wrap">${(e && e.message) ? e.message : 'Nezn√°ma chyba'}</pre>
      </div>`;
    return;
  }

  const out = document.getElementById('out');
  out.style.display='block';
  out.innerHTML = `
    <h3>V√Ωsledok ‚Äì ${data.assessment?.toUpperCase() ?? schema.title}</h3>
    <p><strong>Sk√≥re:</strong> ${data.total} / ${data.max_score}</p>
    ${data.severity ? `<p><strong>Z√°va≈ænos≈•:</strong> ${data.severity}</p>` : ''}
    ${data.advice ? `<p><strong>Odpor√∫ƒçanie:</strong> ${data.advice}</p>` : ''}
    ${data.impairment? `<p><strong>Funkƒçn√Ω dopad:</strong> ${data.impairment}</p>`: ''}
    ${Array.isArray(data.safety_msgs) ? data.safety_msgs.map(m=>`<p class='danger'>${m}</p>`).join('') : ''}
  `;
  out.scrollIntoView({behavior:'smooth', block:'start'});
}

function renderList(list){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  list.forEach(x=>{
    const card = el('div', {class:'mini-card', tabindex:'0', role:'button', 'aria-label': x.name});
    card.appendChild(el('h3', {}, x.name));
    const meta = el('p', {class:'muted small'}, `verzia ${x.version}${x.items_count? ` ‚Ä¢ ${x.items_count} polo≈æiek`: ''}`);
    card.appendChild(meta);
    card.addEventListener('click', ()=> load(x.id, card));
    card.addEventListener('keypress', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); card.click(); }});
    grid.appendChild(card);
  });
  // auto-load prv√∫
  if(list.length){ load(list[0].id, grid.firstChild); }
}
async function load(id, cardEl){
  const s = await fetchSchema(id);
  s.id = id;
  window._schema = s;
  // oznaƒç vybran√∫ kartu
  document.querySelectorAll('#grid .mini-card').forEach(c=> c.classList.remove('active'));
  if(cardEl) cardEl.classList.add('active');
  render(s);
}

(async function init(){
  const list = await fetchList();
  renderList(list);
})();
</script>
{% endblock %}

{% block styles %}
<style>
  .muted{ color:#6b7280; }
  .small{ font-size: 0.9em; }
  .card{ border:1px solid #e5e7eb; border-radius:12px; padding:16px 20px; margin-bottom:16px; }
  .card-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
  .mini-card{
  border:1px solid #1f2937;
  border-radius:12px;
  padding:14px;
  cursor:pointer;
  background:#0f172a;
  color:#e5e7eb;
  transition: transform .08s ease, background .12s ease, border-color .12s ease;
  outline: none;
  }
  .mini-card h3{ margin:0 0 6px; font-size:1.05rem; }
  .mini-card:hover,
.mini-card:focus-visible{
  background:#111f3a;
  border-color:#3b82f6;
  box-shadow:0 0 0 2px rgba(59,130,246,.25) inset;
  transform: translateY(-1px);
}
.mini-card.active{
  border-color:#3b82f6;
  box-shadow:0 0 0 2px rgba(59,130,246,.35) inset;
  background:#112440;
}
  .row{ display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:12px; }
 .scale{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap:8px;
}
  button{ padding:10px 14px; border-radius:10px; border:1px solid #1f2937; background:#111827; color:#fff; cursor:pointer; }
  .result{ background:#f9fafb; color:#111827; }
  .danger{ color:#b91c1c; font-weight:600; }
  @media (max-width:680px){ .scale{ grid-template-columns:1fr; } }
</style>

{% endblock %}
